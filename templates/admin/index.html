{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<style>
    /* Dashboard Container */
    .dashboard-container {
        padding: 1.5rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Welcome Section */
    .welcome-section {
        margin-bottom: 1.5rem;
    }

    .welcome-section h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        color: #1e293b;
    }

    .dark .welcome-section h1 {
        color: #f8fafc;
    }

    .welcome-section p {
        color: #64748b;
    }

    .dark .welcome-section p {
        color: #94a3b8;
    }

    /* Stat Cards */
    .stat-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        padding: 1.25rem;
        border-radius: 16px;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        color: white;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 25px rgba(0, 0, 0, 0.3);
    }

    .stat-card.blue {
        background: linear-gradient(135deg, #3B82F6, #1D4ED8);
    }

    .stat-card.pink {
        background: linear-gradient(135deg, #EC4899, #DB2777);
    }

    .stat-card.green {
        background: linear-gradient(135deg, #10B981, #059669);
    }

    .stat-card.purple {
        background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
    }

    .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
    }

    /* Export Buttons */
    .export-buttons {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .btn-export {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.875rem;
        text-decoration: none;
        color: white;
        transition: all 0.2s ease;
    }

    .btn-export:hover {
        transform: translateY(-2px);
    }

    .btn-export.green {
        background: linear-gradient(135deg, #10B981, #059669);
    }

    .btn-export.red {
        background: linear-gradient(135deg, #EC4899, #DB2777);
    }

    /* Charts */
    .charts-section {
        margin-bottom: 1.5rem;
    }

    .chart-card {
        background: #f8fafc;
        border-radius: 16px;
        padding: 1.25rem;
        border: 1px solid #e2e8f0;
        margin-bottom: 1.25rem;
    }

    .dark .chart-card {
        background: #1e293b;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .chart-card h3 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #1e293b;
    }

    .dark .chart-card h3 {
        color: #f8fafc;
    }

    .chart-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.25rem;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .stat-cards {
            grid-template-columns: repeat(2, 1fr);
        }

        .chart-row {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .stat-cards {
            grid-template-columns: 1fr;
        }
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Welcome -->
    <div class="welcome-section">
        <h1>Welcome, {{ request.user.get_full_name|default:request.user.username }} üëã</h1>
        <p>Here's what's happening with your bookings today.</p>
    </div>

    <!-- Stat Cards -->
    <div class="stat-cards">
        <div class="stat-card blue">
            <div class="stat-icon">üìÖ</div>
            <div>
                <div class="stat-value" id="total-bookings">-</div>
                <div class="stat-label">Total Bookings</div>
            </div>
        </div>
        <div class="stat-card pink">
            <div class="stat-icon">‚è≥</div>
            <div>
                <div class="stat-value" id="pending-bookings">-</div>
                <div class="stat-label">Pending Requests</div>
            </div>
        </div>
        <div class="stat-card green">
            <div class="stat-icon">‚úÖ</div>
            <div>
                <div class="stat-value" id="approved-bookings">-</div>
                <div class="stat-label">Approved</div>
            </div>
        </div>
        <div class="stat-card purple">
            <div class="stat-icon">üè†</div>
            <div>
                <div class="stat-value" id="active-rooms">-</div>
                <div class="stat-label">Active Rooms</div>
            </div>
        </div>
    </div>

    <!-- Export Buttons -->
    <div class="export-buttons">
        <a href="/smartspace-panel-upy/export/dashboard/excel/" class="btn-export green">
            üìä Export Excel
        </a>
        <a href="/smartspace-panel-upy/export/dashboard/pdf/" class="btn-export red">
            üìÑ Export PDF
        </a>
    </div>

    <!-- Charts -->
    <div class="charts-section">
        <div class="chart-card">
            <h3>üìà Booking Trend (Last 30 Days)</h3>
            <canvas id="trendChart" height="100"></canvas>
        </div>

        <div class="chart-row">
            <div class="chart-card">
                <h3>üìä Status Distribution</h3>
                <canvas id="statusChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>üî• Busiest Days</h3>
                <canvas id="dayChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Chart.js global defaults for dark theme
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';

        fetch('/smartspace-panel-upy/api/stats/')
            .then(response => response.json())
            .then(data => {
                if (!data.success) return;

                // Animate stats
                animateValue('total-bookings', data.summary.total);
                animateValue('pending-bookings', data.summary.pending);
                animateValue('approved-bookings', data.summary.approved);
                animateValue('active-rooms', data.summary.active_rooms);

                // ===== TREND CHART (Gradient Line) =====
                const trendCtx = document.getElementById('trendChart').getContext('2d');
                const trendGradient = trendCtx.createLinearGradient(0, 0, 0, 300);
                trendGradient.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
                trendGradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: data.daily_trend.map(d => formatDate(d.date)),
                        datasets: [{
                            label: 'Bookings',
                            data: data.daily_trend.map(d => d.count),
                            borderColor: '#3B82F6',
                            backgroundColor: trendGradient,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#3B82F6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 8,
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#3B82F6',
                            pointHoverBorderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                borderColor: '#3B82F6',
                                borderWidth: 1,
                                titleColor: '#f8fafc',
                                bodyColor: '#94a3b8',
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                                ticks: { padding: 10 }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { padding: 10, maxRotation: 0 }
                            }
                        }
                    }
                });

                // ===== STATUS CHART (Doughnut with shadows) =====
                const statusLabels = data.status_distribution.map(i => i.status);
                const statusValues = data.status_distribution.map(i => i.count);
                const statusColors = {
                    'Approved': '#10B981', 'Pending': '#F59E0B',
                    'Rejected': '#EF4444', 'Cancelled': '#64748B', 'On Process': '#3B82F6'
                };

                new Chart(document.getElementById('statusChart'), {
                    type: 'doughnut',
                    data: {
                        labels: statusLabels,
                        datasets: [{
                            data: statusValues,
                            backgroundColor: statusLabels.map(s => statusColors[s] || '#6B7280'),
                            borderWidth: 0,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    font: { size: 12, weight: '500' }
                                }
                            },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1,
                                padding: 12,
                                cornerRadius: 8
                            }
                        }
                    }
                });

                // ===== BUSIEST DAYS (Gradient Bars) =====
                const dayCtx = document.getElementById('dayChart').getContext('2d');
                const barGradient = dayCtx.createLinearGradient(0, 0, 0, 300);
                barGradient.addColorStop(0, '#8B5CF6');
                barGradient.addColorStop(1, '#6366F1');

                const dayNames = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
                const daysMap = new Array(8).fill(0);
                data.weekly_popularity.forEach(i => { daysMap[i.day] = i.count; });
                const orderedValues = [daysMap[2], daysMap[3], daysMap[4], daysMap[5], daysMap[6], daysMap[7], daysMap[1]];

                new Chart(dayCtx, {
                    type: 'bar',
                    data: {
                        labels: dayNames,
                        datasets: [{
                            data: orderedValues,
                            backgroundColor: barGradient,
                            borderRadius: 8,
                            borderSkipped: false,
                            barThickness: 32,
                            hoverBackgroundColor: '#A78BFA'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                borderColor: '#8B5CF6',
                                borderWidth: 1,
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: ctx => `${ctx.raw} bookings`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                                ticks: { stepSize: 1, padding: 10 }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { padding: 10 }
                            }
                        }
                    }
                });
            });

        // Helper: Animate numbers
        function animateValue(id, end) {
            const el = document.getElementById(id);
            let start = 0;
            const duration = 1000;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                el.textContent = Math.floor(eased * end);
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        // Helper: Format date
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
        }
    });
</script>
{% endblock %}